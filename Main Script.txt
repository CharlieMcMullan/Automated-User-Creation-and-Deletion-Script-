#!/usr/bin/env python3
# read lines from input file and print them to stdout
import sys
import cnsm2 as k
#Console Prompt
print(' ')
print('Scripts purpose: write a user create & user Delete bash script')
print('Author: Charlie McMullan | K00275725')
#checks if argument has been entered
if len(sys.argv) <= 1: #Checks if arguments are greater or equal 1
    print("No Argument Entered ")
    print("Script terminating ")
    print("Script Status: Failed")
    print(' ')
    exit()

else:
#file varibles & prompt to console
   inputfile = sys.argv[1]
   UserAdd = "bash_create_users.sh"
   DelUser = "bash_delete_users.sh"
   print('User list read in from:',inputfile )
   print('User create bash script:',UserAdd )
   print('User Delete bash script:',DelUser )
   print(' ')

#checks file exists
try:
  fh_in = open(inputfile, 'r')
  AddUser_out = open(UserAdd, 'a')#User add script
  DelUser_out = open(DelUser, 'a')#user del script
except OSError as e:#if file doesn't exist
  print('unable to access file')
  print('Check the arugment matches the file name')
  print(' ')
  exit()

counter = 0
#code continues here if file exists
print('File Successful Found')
print(' ')

def CreateUserOpeningPrompt():
  #Opening Propmt
  print('echo " " ',file=AddUser_out)
  print('echo "Bash Script Generated by PythonUsers.py"', file=AddUser_out )
  print('echo "Author: Charlie McMullan | K00275725"', file=AddUser_out )
  print('echo "Scripts purpose: Create Users"', file=AddUser_out )
  print('echo "Users acount info generated from:"',inputfile, file=AddUser_out )
  print('echo " " ', file=AddUser_out)
  #checks user is running script as root
  print('counter=0',file=AddUser_out)#puts a user count into scripts
  print('#checks if used ID = 0 which is roots User ID. This script must be ran as root', file=AddUser_out);
  print('root="root user check:"', file=AddUser_out)
  print('if [[ $EUID == 0 ]]', file=AddUser_out)
  print('then', file=AddUser_out)
  print('echo $root "Successful"', file=AddUser_out)
  print('echo " "', file=AddUser_out)
  print('else', file=AddUser_out)
  print('echo $root "Failed"', file=AddUser_out)
  print('echo script must be run as root',file=AddUser_out)
  print('echo Script Terminated', file=AddUser_out)
  print('echo " " ',file=AddUser_out)
  print('exit', file=AddUser_out)
  print('fi', file=AddUser_out)
  print('echo " " ', file=AddUser_out)
  #prints time the script began adding users
  print('#This creates the user accounts, groups and home dir', file=AddUser_out);
  print('#Prints time of start', file=AddUser_out)
  print('echo "User Creation Start Time:" $(date +"%Y/%m/%d %H:%M:%S")', file=AddUser_out)
CreateUserOpeningPrompt()

def DeleteUserOpeningPrompt():
  #Opening Propmt
  print('echo " " ',file=DelUser_out)
  print('echo "Bash Script Generated by PythonUsers.py"',file=DelUser_out)
  print('echo "Author: Charlie McMullan | K00275725"',file=DelUser_out)
  print('echo "Scripts purpose: delete Users"',file=DelUser_out)
  print('echo "Users acount info generated from:"',inputfile,file=DelUser_out)
  print('echo " " ', file=DelUser_out)
  #checks user is running script as root
  print('counter=0', file=DelUser_out)
  print('#checks if used ID = 0 which is roots User ID. This script must be ran as root', file=DelUser_out);
  print('root="root user check:"', file=DelUser_out)
  print('if [[ $EUID == 0 ]]', file=DelUser_out)
  print('then', file=DelUser_out)
  print('echo $root "Successful"', file=DelUser_out)
  print('echo " "', file=DelUser_out)
  print('else', file=DelUser_out)
  print('echo $root "Failed"', file=DelUser_out)
  print('echo script must be run as root', file=DelUser_out)
  print('echo Script Terminated', file=DelUser_out)
  print('echo $error', file=DelUser_out)
  print('echo " " ',file=DelUser_out)
  print('exit', file=DelUser_out)
  print('fi', file=DelUser_out)
  print('echo " " ',file=DelUser_out)
  #prints time the script began adding users
  print('#This deletes users and their content', file=DelUser_out);
  print('#Prints time of start', file=DelUser_out)
  print('echo "User Deletion Start Time:" $(date +"%Y/%m/%d %H:%M:%S")', file=DelUser_out)
DeleteUserOpeningPrompt()

for line in fh_in: #goes through each line from user file
  line = line.rstrip() #cleans up the returned values from the file. eg removing spaces
  parts=line.split(',') #removes commas that seperate the users data on each line
  #Create/Del users needs: username, fullname, id_number, password
  line = line.rstrip() #cleans up the returned values from the file. eg removing spaces
  parts=line.split(',') #removes commas that seperate the users data on each line
  firstname = parts[1] #takes in second input on line
  surname = parts[0]#takes in first input on line
  password = parts[2]#takes in third input on line
  id_number = parts[3]#takes in forth input on line
  username = firstname+'.'+surname #generate required template for usernames
  username=username.lower()#coneverts username to lowercase characters only
  fullname = firstname+' '+surname
  #Create user needs username,fullname,id_number,password & file
  k.CreateUsers(username,fullname,id_number,password,AddUser_out,counter)
  k.DeleteUser(username,DelUser_out,counter)
  counter=counter+1


total = str(counter)

def CreateUserClosingPrompt():
  #end prompt displays finish time
  print('#Prints time of finish', file=AddUser_out)
  print('echo "User Creation Finish Time:" $(date +"%Y/%m/%d %H:%M:%S")', file=AddUser_out)
  print('echo " " ', file=AddUser_out)
  #adds total count of users to file, this can be compared against the count of users created
  print('total='+total,file=AddUser_out)
  print('echo Users Added!', file=AddUser_out )
  print('echo Users Created: $counter of $total', file=AddUser_out )
  print('echo "Script Status: Complete"', file=AddUser_out )
CreateUserClosingPrompt()

def DeleteUserClosingPrompt():
  #end prompt displays finish time
  print('#Prints time of finish', file=DelUser_out)
  print('echo "User Deletion Finish Time:" $(date +"%Y/%m/%d %H:%M:%S")', file=DelUser_out)
  print('echo " " ',file=DelUser_out)
  #adds total count of users to file, this can be compared against the count of users deleted
  print('total='+total,file=DelUser_out )
  print('echo Users Deleted!', file=DelUser_out )
  print('echo Users Proccessed: $counter of $total', file=DelUser_out )
  print('echo "Script Status: Complete"', file=DelUser_out )
DeleteUserClosingPrompt()

#closing prompts for main script
#counter
total = str(counter)
print('Users Proccessed:',total)
#completetion Status
print('Generating bash script',UserAdd,'status: Complete')
print('Generating bash script',DelUser,'status: Complete')
print('Script Status: Complete')
print('')
# close opened files
fh_in.close()
AddUser_out.close()
DelUser_out.close()
